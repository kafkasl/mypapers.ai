<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3MVESGM9D3"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-3MVESGM9D3');
    </script>
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mypapers.ai</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.0/dist/tailwind.min.css" rel="stylesheet">

    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.ico') }}">
</head>

<body class="bg-white text-gray-900 flex h-screen">
    <div id="loading" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50">
        <svg class="animate-spin h-12 w-12 text-blue-900" xmlns="http://www.w3.org/2000/svg" fill="none"
            viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
        </svg>
    </div>
    <div id="cy" class="w-3/4 h-full"></div>
    <div class="absolute top-0 left-0 p-4">
        <h1 class="text-4xl font-bold mb-1 text-gray-900">mypapers.ai</h1>
        <h3 class="text-xl text-blue-500">alpha version</h3>
    </div>
    <div class="w-1/4 h-full bg-gray-900 overflow-y-auto p-4 flex flex-col">

        <div id="info" class="p-4 bg-white shadow-lg rounded-lg mb-auto">
            Click on a node to see more information here.
        </div>
        <div class="mt-auto">
            <div class="text-left text-white mb-4">
                <ul>
                    <li class="mb-4">Follow the journey on <a href="https://x.com/pol_avec" class="text-blue-400"
                            target="_blank" rel="noopener noreferrer">X</a>
                    </li>
                    <li>Check out the code on <a href="https://github.com/kafkasl/mypapers.ai" target="_blank"
                            rel="noopener noreferrer" class="text-blue-400">GitHub</a></li>
                </ul>
            </div>
        </div>
    </div>
    </div>
    <script>

        const API_URL = "{{ api_url }}";
        console.log(API_URL);
        async function fetchData() {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query: `{
                        getAllData {
                            papers { id title publicationDate summary link }
                            authors { id name }
                            links { source target }
                        }
                    }`
                })
            });
            const data = await response.json();
            return data.data.getAllData;
        }

        function formatDate(dateStr) {
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);

            const date = new Date(`${year}-${month}-${day}`);
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function processGraphData(data) {
            const elements = [];
            data.papers.forEach(paper => {
                elements.push({ data: { id: paper.id, label: paper.title, type: 'paper', publicationDate: paper.publicationDate, summary: paper.summary, link: paper.link } });
            });

            data.authors.forEach(author => {
                elements.push({ data: { id: author.id, label: author.name, type: 'author' } });
            });

            data.links.forEach(link => {
                elements.push({ data: { source: link.source, target: link.target, label: 'authored by' } });
            });

            return elements;
        }

        async function initializeGraph() {
            const data = await fetchData();
            const elements = processGraphData(data);

            var cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: [
                    {
                        selector: 'node[type="paper"]',
                        style: {
                            'background-color': '#003366',
                            'label': 'data(label)',
                            'text-valign': 'center',
                            'text-outline-width': 2,
                            'text-outline-color': 'white',
                            'font-size': '12px',
                            'text-wrap': 'ellipsis',
                            'text-max-width': '140px'
                        }
                    },
                    {
                        selector: 'node[type="author"]',
                        style: {
                            'background-color': '#89CFF0',
                            'label': 'data(label)',
                            'text-valign': 'center',
                            'text-outline-width': 2,
                            'text-outline-color': 'white',
                            'font-size': '12px',
                            'text-max-width': '80px'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'curve-style': 'bezier',
                            'width': 1,
                            'line-color': '#D3D3D3', // Cool Gray for edges
                            'target-arrow-color': '#D3D3D3',
                            'arrow-scale': 0.5
                        }
                    }
                ],
                layout: {
                    name: 'cose',
                    idealEdgeLength: 100,
                    nodeOverlap: 20,
                    refresh: 20,
                    fit: true,
                    padding: 30,
                    randomize: false,
                    componentSpacing: 100,
                    nodeRepulsion: 400000,
                    edgeElasticity: 100,
                    nestingFactor: 5,
                }
            });

            cy.on('render', () => {
                document.getElementById('loading').style.display = 'none';
            });

            cy.on('tap', 'node', function (evt) {
                var node = evt.target;
                var nodeType = node.data('type');
                var infoContent = '';

                if (nodeType === 'paper') {
                    infoContent = `
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Paper</h2>
                        <p class="text-gray-700 mb-2"><strong>Title:</strong> ${node.data('label')}</p>
                        <p class="text-gray-700 mb-2"><strong>Publication Date:</strong> ${formatDate(node.data('publicationDate'))}</p>
                        <p class="text-gray-700 mb-2"><strong>Summary:</strong> ${node.data('summary')}</p>
                        <p class="text-gray-700 mb-2"><strong>Link:</strong><a target="_blank" rel="noopener noreferrer" href="${node.data('link')}" class="text-blue-500 hover:text-blue-700"> Read paper</a></p>
                    `;
                } else if (nodeType === 'author') {
                    infoContent = `
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Author</h2>
                        <p class="text-gray-700"><strong>Name:</strong> ${node.data('label')}</p>
                    `;
                }

                document.getElementById('info').innerHTML = infoContent;
            });
        }

        initializeGraph();
    </script>



    <!-- begin olark code -->
    <script type="text/javascript" async>
        ; (function (o, l, a, r, k, y) {
            if (o.olark) return;
            r = "script"; y = l.createElement(r); r = l.getElementsByTagName(r)[0];
            y.async = 1; y.src = "//" + a; r.parentNode.insertBefore(y, r);
            y = o.olark = function () { k.s.push(arguments); k.t.push(+new Date) };
            y.extend = function (i, j) { y("extend", i, j) };
            y.identify = function (i) { y("identify", k.i = i) };
            y.configure = function (i, j) { y("configure", i, j); k.c[i] = j };
            k = y._ = { s: [], t: [+new Date], c: {}, l: a };
        })(window, document, "static.olark.com/jsclient/loader.js");/* custom configuration goes here (www.olark.com/documentation) */olark.identify('6674-726-10-8637');</script>
    <!-- end olark code -->
</body>

</html>