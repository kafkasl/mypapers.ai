<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Papers and Authors Network</title>
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre/cytoscape-dagre.js"></script>
    <style>
        #cy {
            width: 70%;
            height: 90vh;
            position: absolute;
            left: 0;
            top: 0;
        }

        #info {
            width: 30%;
            height: 90vh;
            position: absolute;
            right: 0;
            top: 0;
            background: #f4f4f4;
            overflow-y: auto;
            padding: 10px;
        }

        body {
            margin: 0;
            display: flex;
            height: 100vh;
        }
    </style>
</head>

<body>
    <div id="cy"></div>
    <div id="info">Click on a node to see more information here.</div>
    <script>
        async function fetchData() {
            const response = await fetch('http://127.0.0.1:5001/graphql', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query: `{
                        getAllData {
                            papers { id title }
                            authors { id name }
                            links { source target }
                        }
                    }`
                })
            });
            const data = await response.json();
            return data.data.getAllData;
        }

        function processGraphData(data) {
            const elements = [];
            const linkCount = {};
            const minCount = 0;

            // Count each author's occurrences in the links
            data.links.forEach(link => {
                linkCount[link.target] = (linkCount[link.target] || 0) + 1;
            });

            data.papers.forEach(paper => {
                elements.push({ data: { id: paper.id, label: paper.title, type: 'paper' } });
            });

            data.authors.forEach(author => {
                // if (linkCount[author.id] > minCount) {  // Only add authors with more than 2 links
                elements.push({ data: { id: author.id, label: author.name, type: 'author' } });
                // }
            });

            data.links.forEach(link => {
                // if (linkCount[link.target] > minCount) {  // Only add links for authors with more than 2 links
                elements.push({ data: { source: link.source, target: link.target, label: 'authored by' } });
                // }
            });

            return elements;
        }

        async function initializeGraph() {
            const data = await fetchData();
            const elements = processGraphData(data);

            var cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: [
                    {
                        selector: 'node[type="paper"]',
                        style: {
                            'background-color': '#1167b1',
                            'label': 'data(label)',
                            'text-valign': 'center',
                            'color': 'white',
                            'text-outline-width': 2,
                            'text-outline-color': '#1167b1',
                            'font-size': '12px',
                            'text-wrap': 'ellipsis',
                            'text-max-width': '80px'
                        }
                    },
                    {
                        selector: 'node[type="author"]',
                        style: {
                            'background-color': '#34a853',
                            'label': 'data(label)',
                            'text-valign': 'center',
                            'color': 'white',
                            'text-outline-width': 2,
                            'text-outline-color': '#34a853',
                            'font-size': '12px',
                            'text-wrap': 'ellipsis',
                            'text-max-width': '80px'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'curve-style': 'bezier',
                            'width': 3,
                            'line-color': '#888',
                            'target-arrow-color': '#888',
                            'target-arrow-shape': 'triangle',
                            'arrow-scale': 1.5
                        }
                    }
                ],
                layout: {
                    name: 'dagre',
                    padding: 10,
                    spacingFactor: 0.5,
                    nodeSep: 100,
                    edgeSep: 100,
                    // rankDir: 'LR',
                }
            });

            cy.on('tap', 'node', function (evt) {
                var node = evt.target;
                document.getElementById('info').innerHTML = `
                    <h2>Details</h2>
                    <p><strong>ID:</strong> ${node.id()}</p>
                    <p><strong>Label:</strong> ${node.data('label')}</p>
                    <p><strong>Type:</strong> ${node.data('type')}</p>
                `;
            });
        }

        initializeGraph();
    </script>
</body>

</html>